#!/bin/bash

# if [ "${0##*/}" != "bash" ] && [ "${SHELL##*/}" != "bash" ]; then
        # echo "This script should be run with bash, not ${0##*/}"
        # exit 1
# fi

function list_env()
{
  echo "env availables:"
  echo "==============="
  find ~/.config \( -type l -or -type d \) -iname 'nvim-*' -exec basename {} \; | sort
  echo ""
  echo "actual env:"
  echo "==========="
  env=$(readlink ~/.config/nvim)
  basename $env
  echo ""

  check_env
  exit 1
}

function is_symlink_folder()
{
  if [[ -L "$1" && -d "$1" ]]; then
    echo "folder $1: ok"
    true
  else
    echo "folder $1 should be a symlink !"
    false
  fi
}

function check_env()
{
  echo "Cheking actual env:"
  echo "==================="
  ISOK=true
  is_symlink_folder ~/.config/nvim || ISOK=false
  is_symlink_folder ~/.local/share/nvim || ISOK=false
  is_symlink_folder ~/.local/state/nvim || ISOK=false
  is_symlink_folder ~/.cache/nvim || ISOK=false
  echo ""
  $ISOK
}

function clear_nvim()
{
  rm -f $HOME/.config/nvim
  rm -f $HOME/.local/share/nvim
  rm -f $HOME/.local/state/nvim
  rm -f $HOME/.cache/nvim
}

if [[ $# -lt 1 ]]; then
  list_env
fi

if [[ $1 != nvim-* ]]; then
    echo "Environment name should start with 'nvim-'"
    echo -n "Do you want to use nvim-${1} ? "
    read choice
    case $choice in
        [Yy]) ENV_NAME="nvim-${1}";;
        *)    exit 1;;
    esac
else
    ENV_NAME=$1
fi

if [ ! -d "$HOME/.config/${ENV_NAME}" ] && [ ! -L "$HOME/.config/${ENV_NAME}"  ]; then
  echo -n "environment ${ENV_NAME} not found, do you want to create it ? "
  read choice
  case $choice in
  [Yy]) echo "ok, we will proceed";;
  [Nn]) exit 1;;
  esac
fi

if [[ ! check_env ]]; then
  echo "ERROR: env isn't clean"
  exit 1
fi

echo "Switch neovim to env ${ENV_NAME}"
clear_nvim

mkdir -p ~/.config/${ENV_NAME}
ln -s ~/.config/${ENV_NAME} ~/.config/nvim

mkdir -p ~/.local/share/${ENV_NAME}
ln -s ~/.local/share/${ENV_NAME} ~/.local/share/nvim

mkdir -p ~/.local/state/${ENV_NAME}
ln -s ~/.local/state/${ENV_NAME} ~/.local/state/nvim

mkdir -p ~/.cache/${ENV_NAME}
ln -s ~/.cache/${ENV_NAME} ~/.cache/nvim
